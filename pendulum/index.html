<!DOCTYPE html>
<html>
    <head>
        <style>            
            svg {
                border: 1px solid goldenrod;
            }
            .container {
                display: flex;
                justify-content: center;
            }
        </style>

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-72137960-1"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-72137960-1');
        </script>

    </head>
    <body>
        <div class="container">
            <div class="article">
                <h1>Pendulum</h1>
                <svg width="500" height="350"></svg>
            </div>
        </div>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="./dist/bundle.js"></script>
        <script>

            const width = 500
            const height = 300
            
            const barWidth = 100
            let l = 200;
            let theta = Math.PI / 3

            const originX = width / 2
            const originY = 0

            const dt = 10.0 / 1000            

            let animationStarted = true

            const svg = d3.select("svg")
            svg.append("line")
                .attr("x1", (width - barWidth) / 2)
                .attr("y1", 0)
                .attr("x2", (width + barWidth) / 2)
                .attr("y2", 0)
                .attr("stroke", "black")
                .attr("stroke-width", 3)

            svg.append("line")
                .attr("id", "rod")
                .attr("x1", width / 2)
                .attr("y1", 0)
                .attr("x2", l * Math.sin(theta))
                .attr("y2", l * Math.cos(theta))
                .attr("stroke", "black")

            svg
                .on("mousedown", () => {
                    const { offsetX, offsetY } = d3.event
                    const dx = offsetX - originX
                    const dy = offsetY - originY

                    l = Math.sqrt(dx * dx + dy * dy)
                    theta = Math.atan(dx / dy)

                    updateScene(svg, theta, l)

                    animationStarted = false

                })
                .on("mouseup", () => {
                    animationStarted = true
                    
                    solution = pendulum.solve(l / 200.0, theta, dt)
                    frame = 0
                    window.requestAnimationFrame(animate)
                })

            svg.append("circle")
                .attr("id", "ball")
                .attr("cx", l * Math.sin(theta))
                .attr("cy", l * Math.cos(theta))
                .attr("r", 10)
                .attr("fill", "black")

            function updateScene(svg, theta, l) {
                svg.select("#rod")
                    .attr("x2", l * Math.sin(theta) + width / 2)
                    .attr("y2", l * Math.cos(theta))

                svg.select("#ball")
                    .attr("cx", l * Math.sin(theta) + width / 2)
                    .attr("cy", l * Math.cos(theta))

            }
                
            let solution = pendulum.solve(1.0, theta, dt)
            let frame = 0
            let lastUpdate = 0

            function animate(timestamp) {
                if (!animationStarted) {
                    return
                }
                
                updateScene(svg, solution[frame][1], l)

                if (timestamp - lastUpdate > 20) {
                    frame = (frame + 1) % solution.length
                    lastUpdate = timestamp
                }
                window.requestAnimationFrame(animate)
            }

            window.requestAnimationFrame(animate)
        </script>
    </body>
</html>